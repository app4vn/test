<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Bản đồ khuôn viên - Highlight Mục Tìm Kiếm</title>
    <style>
      /* General body styles */
      body {
        margin: 0;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 5px;
        box-sizing: border-box;
        background-color: #f0f0f0;
        overscroll-behavior: none; /* Prevent pull-to-refresh */
        min-height: 100vh;
      }

      /* --- Search Bar Area --- */
      .search-area-container {
        width: 100%;
        max-width: 900px;
        padding: 8px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 8px;
        box-sizing: border-box;
        position: relative; 
        z-index: 1000; 
        flex-shrink: 0;
      }
      #searchInput {
        width: 100%;
        padding: 10px;
        font-size: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      #searchResultsContainer {
        position: absolute;
        top: 100%; 
        left: 8px;
        right: 8px;
        background-color: white;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px; 
        overflow-y: auto; 
        z-index: 999; 
        display: none; 
      }
      #searchResultsContainer ul { list-style: none; margin: 0; padding: 0; }
      #searchResultsContainer li { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
      #searchResultsContainer li:last-child { border-bottom: none; }
      #searchResultsContainer li:hover { background-color: #f0f0f0; }
      #searchResultsContainer li strong { color: #007bff; } /* Nổi bật tên thực thể tìm thấy */
      #searchResultsContainer .no-results { padding: 10px; color: #777; text-align: center; }
      #searchResultsContainer .error-message { padding: 10px; color: #dc3545; text-align: center; font-style: italic; }

      /* --- Map Container --- */
      .map-container {
        width: 100%; max-width: 900px; border: 1px solid #007bff;
        border-radius: 8px; overflow: hidden; background-color: white;
        height: 55vh; display: flex; align-items: center; justify-content: center;
        position: relative; margin-bottom: 0; box-sizing: border-box;
      }

      /* --- SVG Map Styles --- */
      svg#campusMap {
        width: 100%; height: 100%; display: block; cursor: grab;
        user-select: none; touch-action: none;
      }
      svg#campusMap.grabbing { cursor: grabbing; }

      /* --- Building Rectangles --- */
      rect.building-rect {
        fill: transparent; pointer-events: all; stroke: none;
        transition: stroke 0.2s ease-out, stroke-width 0.2s ease-out;
      }
      rect.building-rect.search-highlight { stroke: #00e676 !important; stroke-width: 3.5px !important; }
      .divider-line { stroke: rgba(128, 128, 128, 0.4); stroke-width: 1px; stroke-dasharray: 3, 3; pointer-events: none; }

      /* --- Reset Zoom Button --- */
      .reset-zoom-icon-btn {
        position: absolute; bottom: 10px; right: 10px; z-index: 10;
        background-color: rgba(255, 255, 255, 0.8); border: 1px solid #ccc;
        border-radius: 50%; width: 36px; height: 36px; padding: 0;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: background-color 0.2s ease;
      }
      .reset-zoom-icon-btn:hover { background-color: rgba(240, 240, 240, 0.9); }
      .reset-zoom-icon-btn svg { fill: #333; }

      /* --- Inserted Image Styles --- */
      .inserted-image-container {
        width: 100%; max-width: 900px; margin: 15px auto;
        padding: 0 8px; box-sizing: border-box; text-align: center;
      }
      .inserted-image-container img {
        max-width: 100%; height: auto; display: block; margin: 0 auto;
        border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }

      /* --- Bottom Sheet Styles --- */
      .bottom-sheet-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.05); z-index: 1010; opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0s linear 0.3s; }
      .bottom-sheet-backdrop.open { opacity: 1; visibility: visible; transition: opacity 0.3s ease-in-out, visibility 0s linear 0s; }
      .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; width: 100%; max-width: 900px; margin-left: auto; margin-right: auto; background-color: #ffffff; border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.15); z-index: 1020; transform: translateY(100%); transition: transform 0.3s ease-in-out, height 0.3s ease-in-out; display: flex; flex-direction: column; touch-action: pan-y; }
      .bottom-sheet.open { transform: translateY(0); }
      .bottom-sheet.no-transition { transition: none !important; }
      .bottom-sheet-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; border-bottom: 1px solid #e0e0e0; flex-shrink: 0; cursor: grab; touch-action: pan-y; }
      .bottom-sheet-header:active { cursor: grabbing; }
      .bottom-sheet-title { font-size: 1.1em; font-weight: 600; color: #333; margin-right: 10px; user-select: none; }
      .bottom-sheet-actions { display: flex; align-items: center; gap: 8px; }
      .bottom-sheet-action-btn { background: none; border: none; padding: 6px; cursor: pointer; color: #757575; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s ease; }
      .bottom-sheet-action-btn:hover { color: #333; background-color: #f0f0f0; }
      .bottom-sheet-action-btn svg { fill: currentColor; width: 22px; height: 22px; }
      .bottom-sheet-action-btn.close-btn { font-size: 24px; line-height: 1; padding: 4px 8px; }
      .bottom-sheet-action-btn.toggle-height-btn .icon-arrow-down { display: none; }
      .bottom-sheet-action-btn.toggle-height-btn.expanded .icon-arrow-up { display: none; }
      .bottom-sheet-action-btn.toggle-height-btn.expanded .icon-arrow-down { display: block; }
      .bottom-sheet-content { padding: 0 16px 16px 16px; overflow-y: auto; flex-grow: 1; touch-action: auto; }
      .bottom-sheet-content .placeholder { color: #999; font-style: italic; text-align: center; margin-top: 20px; }
      .bottom-sheet-content .error-message { color: #dc3545; font-weight: bold; text-align: center; margin-top: 20px; }
      
      .building-details { }
      .building-image-container { margin-bottom: 12px; text-align: center; }
      .building-image-container img { max-width: 100%; max-height: 200px; width: auto; height: auto; display: inline-block; border-radius: 8px; object-fit: cover; background-color: #eee; vertical-align: middle; }
      .building-info { }
      .building-name { font-size: 1.4em; font-weight: 600; color: #333; margin-top: 0; margin-bottom: 8px; line-height: 1.3; }
      .building-description { font-size: 1em; line-height: 1.6; color: #555; margin-top: 0; margin-bottom: 12px; }
      .building-description img { max-width: 100%; height: auto; display: block; margin: 10px auto; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
      .building-description ul { margin-left: 20px; padding-left: 0;}

      .info-section { margin-top: 10px; font-size: 0.95em; line-height: 1.4; }
      .info-section strong { color: #444; }
      .info-section ul { list-style: none; padding-left: 15px; margin-top: 5px; margin-bottom: 0; }
      .info-section ul li { margin-bottom: 3px; }
      .info-section a { color: #007bff; text-decoration: none; }
      .info-section a:hover { text-decoration: underline; }

      .detail-images-gallery { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
      .detail-images-gallery img { width: calc(33.333% - 6px); max-width: 120px; height: 80px; border-radius: 4px; object-fit: cover; border: 1px solid #ddd; cursor: pointer; transition: transform 0.2s ease; }
      .detail-images-gallery img:hover { transform: scale(1.05); }

      /* --- Tab Styles --- */
      .tab-navigation { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; margin-left: -16px; margin-right: -16px; padding-left: 16px; padding-right: 16px; background-color: #f9f9f9;}
      .tab-button { padding: 10px 15px; cursor: pointer; border: none; background-color: transparent; border-bottom: 3px solid transparent; margin-right: 1px; font-size: 0.9em; color: #555; outline: none;}
      .tab-button:hover { color: #007bff; }
      .tab-button.active { border-bottom: 3px solid #007bff; color: #007bff; font-weight: 600; }
      .tab-panel { display: none; animation: fadeIn 0.3s ease-in-out; }
      .tab-panel.active { display: block; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      .tab-panel h4 { margin-top: 0; margin-bottom: 10px; font-size: 1.05em; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;}
      .tab-panel ul { list-style: none; padding-left: 0; }
      .tab-panel ul li { padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9em; }
      .tab-panel ul li:last-child { border-bottom: none; }
      .tab-panel ul li strong { display: block; color: #333;}
      .tab-panel ul li small { color: #777; }
      .highlighted-entity {
        background-color: #fff3cd !important; /* Màu vàng nhạt */
        border-left: 4px solid #ffe082 !important; /* Đường kẻ vàng bên trái */
        padding-left: 8px !important; 
        margin-left: -12px !important; /* Điều chỉnh nếu padding của li cha làm lệch */
        padding-right: 8px !important;
        margin-right: -8px !important; /* Điều chỉnh cho cân đối */
        border-radius: 4px !important;
      }

      /* --- App Footer Styles --- */
      .app-footer { width: 100%; max-width: 900px; padding: 15px 10px; box-sizing: border-box; text-align: center; font-size: 0.85em; color: #888; margin-top: auto; flex-shrink: 0; border-top: 1px solid #e0e0e0; background-color: #f9f9f9; }
      .app-footer p { margin: 0; }
    </style>
  </head>
  <body>
    <div class="search-area-container">
      <input type="text" id="searchInput" placeholder="Tìm tên hoặc mã tòa nhà..." disabled />
      <div id="searchResultsContainer"><ul id="searchResultsList"></ul></div>
    </div>

    <div class="map-container">
      <svg id="campusMap" viewBox="5 5 960 900" xmlns="http://www.w3.org/2000/svg" >
        <image href="https://app4vn.github.io/hustmap/anh-nen-goc.jpg" x="0" y="0" width="970" height="910" onerror="this.onerror=null; this.src='https://placehold.co/970x910/cccccc/ffffff?text=Map+Image+Not+Found';" />
        <line class="divider-line" x1="485" y1="0" x2="485" y2="910" />
        <line class="divider-line" x1="0" y1="455" x2="970" y2="455" />
        <rect class="building-rect" id="toaC2" x="140" y="320" width="40" height="120"/> <rect class="building-rect" id="toaC9" x="60" y="450" width="130" height="30"/> <rect class="building-rect" id="toaHoithao" x="140" y="270" width="40" height="40"/> <rect class="building-rect" id="toaC1" x="150" y="200" width="270" height="60"/> <rect class="building-rect" id="toaC3" x="400" y="280" width="100" height="30"/> <rect class="building-rect" id="toaC4" x="395" y="350" width="105" height="30"/> <rect class="building-rect" id="toaC5" x="395" y="420" width="105" height="30"/> <rect class="building-rect" id="toaC10" x="397" y="480" width="100" height="30"/> <rect class="building-rect" id="toaC7" x="540" y="410" width="100" height="100"/> <rect class="building-rect" id="toaThuvien" x="440" y="570" width="90" height="120"/> <rect class="building-rect" id="toaHotien" x="250" y="690" width="150" height="110"/> <rect class="building-rect" id="toaD6" x="100" y="680" width="120" height="30"/> <rect class="building-rect" id="toaD8" x="100" y="750" width="120" height="30"/> <rect class="building-rect" id="toaD2a" x="80" y="560" width="70" height="50"/> <rect class="building-rect" id="toaD2b" x="160" y="560" width="70" height="50"/> <rect class="building-rect" id="toaVietduc" x="240" y="560" width="70" height="50"/> <rect class="building-rect" id="toaD2d" x="320" y="560" width="80" height="50"/> <rect class="building-rect" id="toaC3b" x="540" y="230" width="90" height="100"/> <rect class="building-rect" id="toaC1b" x="460" y="210" width="50" height="50"/> <rect class="building-rect" id="toaD3" x="580" y="560" width="70" height="40"/> <rect class="building-rect" id="toaD5" x="580" y="620" width="70" height="40"/> <rect class="building-rect" id="toaD35" x="660" y="560" width="40" height="100"/> <rect class="building-rect" id="toaB6" x="750" y="300" width="100" height="30"/> <rect class="building-rect" id="toaKtx" x="750" y="345" width="100" height="65"/> <rect class="building-rect" id="toaB7" x="750" y="420" width="100" height="30"/> <rect class="building-rect" id="toaB8" x="750" y="470" width="110" height="30"/> <rect class="building-rect" id="toaB5" x="870" y="310" width="80" height="40"/> <rect class="building-rect" id="toaB9" x="870" y="370" width="80" height="40"/> <rect class="building-rect" id="toaB1" x="780" y="565" width="130" height="130"/> <rect class="building-rect" id="toaD4" x="20" y="695" width="50" height="45"/> <rect class="building-rect" id="toaVuonhoa" x="230" y="280" width="110" height="140"/> <rect class="building-rect" id="toaD7" x="610" y="670" width="60" height="60"/>
      </svg>
      <button id="resetZoomIconBtn" class="reset-zoom-icon-btn" title="Xem toàn bộ bản đồ" >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px" > <path d="M0 0h24v24H0z" fill="none" /> <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z" /> </svg>
      </button>
    </div>

    <div class="inserted-image-container">
       <img src="IMG_0709.webp" alt="Ảnh khuôn viên trường - Đại học Bách Khoa Hà Nội">
    </div>

    <div id="bottomSheetBackdrop" class="bottom-sheet-backdrop"></div>
    <div id="bottomSheet" class="bottom-sheet">
      <div id="bottomSheetHeader" class="bottom-sheet-header">
        <span id="bottomSheetTitle" class="bottom-sheet-title">Thông tin tòa nhà</span>
        <div class="bottom-sheet-actions">
          <button id="toggleBottomSheetHeightBtn" class="bottom-sheet-action-btn toggle-height-btn" aria-label="Mở rộng" > <svg class="icon-arrow-up" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor" > <path d="M0 0h24v24H0V0z" fill="none" /> <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z" /> </svg> <svg class="icon-arrow-down" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor" style="display: none" > <path d="M0 0h24v24H0V0z" fill="none" /> <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" /> </svg> </button>
          <button id="closeBottomSheetBtn" class="bottom-sheet-action-btn close-btn" aria-label="Đóng" >&times;</button>
        </div>
      </div>
      <div id="bottomSheetContent" class="bottom-sheet-content">
        <p class="placeholder">Chọn một tòa nhà trên bản đồ hoặc từ kết quả tìm kiếm để xem thông tin chi tiết.</p>
      </div>
    </div>

    <footer class="app-footer"> <p>&copy; 2025 Bản đồ Khuôn viên. Phát triển bởi MinhVTV4.</p> </footer>

    <template id="buildingDetailTemplate">
      <div class="building-details">
        <div class="building-image-container" data-role="image-container">
          <img data-role="building-image" src="" alt="">
        </div>
        <div class="building-info">
          <h3 class="building-name" data-role="building-name" style="padding: 0 16px; margin-top: 16px;"></h3>

          <div class="tab-navigation" data-role="tab-navigation">
            <button class="tab-button" data-tab-target="#tab-overview" data-role="overview-tab-button">Tổng quan</button>
            <button class="tab-button" data-tab-target="#tab-units" data-role="units-tab-button">Đơn vị</button>
          </div>

          <div class="tab-content-area">
            <div class="tab-panel" id="tab-overview">
              <p class="building-description" data-role="building-description"></p>
              <div class="detail-images-gallery" data-role="detail-images-section"></div>
              <div class="info-section" data-role="opening-hours-section">
                <strong>Giờ mở cửa:</strong> <ul data-role="building-opening-hours-list"></ul>
              </div>
              <div class="info-section" data-role="phone-section">
                <strong>Điện thoại:</strong> <span data-role="building-phone"></span>
              </div>
              <div class="info-section" data-role="website-section">
                <strong>Website:</strong> <a data-role="building-website-link" href="#" target="_blank" rel="noopener noreferrer"><span data-role="building-website-text"></span></a>
              </div>
              <div class="info-section" data-role="services-section">
                <strong>Dịch vụ nổi bật:</strong> <ul data-role="building-services-list" style="list-style-type: disc; padding-left: 20px;"></ul>
              </div>
            </div>

            <div class="tab-panel" id="tab-units" data-role="units-content-panel">
              <h4>Các Đơn vị trực thuộc</h4>
              <ul data-role="units-list"></ul>
            </div>
          </div>
        </div>
      </div>
    </template>

    <script>
      //--------------------------------------------------------------------
      // DOM Element References
      //--------------------------------------------------------------------
      const campusMap = document.getElementById("campusMap");
      const searchInput = document.getElementById("searchInput");
      const searchResultsContainer = document.getElementById("searchResultsContainer");
      const searchResultsList = document.getElementById("searchResultsList");
      const resetZoomBtn = document.getElementById("resetZoomIconBtn");
      const bottomSheet = document.getElementById("bottomSheet");
      const bottomSheetBackdrop = document.getElementById("bottomSheetBackdrop");
      const bottomSheetHeader = document.getElementById("bottomSheetHeader");
      const closeBottomSheetBtn = document.getElementById("closeBottomSheetBtn");
      const bottomSheetContent = document.getElementById("bottomSheetContent"); 
      const bottomSheetTitle = document.getElementById("bottomSheetTitle");
      const toggleBottomSheetHeightBtn = document.getElementById("toggleBottomSheetHeightBtn");
      let buildingDetailTemplate; 

      //--------------------------------------------------------------------
      // Global State Variables
      //--------------------------------------------------------------------
      let buildingData = []; 
      let detailedBuildingDataCache = {}; 
      const SVG_VIEWBOX_X = 5, SVG_VIEWBOX_Y = 5;
      const SVG_IMAGE_FULL_WIDTH = 970, SVG_IMAGE_FULL_HEIGHT = 910;
      const SVG_ORIGINAL_WIDTH = SVG_IMAGE_FULL_WIDTH - 2 * SVG_VIEWBOX_X;
      const SVG_ORIGINAL_HEIGHT = SVG_IMAGE_FULL_HEIGHT - 2 * SVG_VIEWBOX_Y;
      const SVG_ASPECT_RATIO = SVG_ORIGINAL_WIDTH / SVG_ORIGINAL_HEIGHT;
      let currentViewBox = { x: SVG_VIEWBOX_X, y: SVG_VIEWBOX_Y, width: SVG_ORIGINAL_WIDTH, height: SVG_ORIGINAL_HEIGHT };
      const ZOOM_FACTOR = 1.2, MIN_ZOOM_WIDTH = 30, MAX_ZOOM_WIDTH = SVG_ORIGINAL_WIDTH * 3;
      let isPointerDown = false, pointerStartCoords = { x: 0, y: 0 }, viewBoxOnPointerDown = { x: 0, y: 0 };
      let initialPinchDistance = 0, isPinching = false;
      let tapStart = { x: 0, y: 0, time: 0 };
      const TAP_THRESHOLD_MS = 250, TAP_MOVE_THRESHOLD_PX = 10;
      let debounceTimer, highlightTimeout = null, autoZoomOutTimer = null;
      let isAnimatingViewBox = false, animationFrameId = null, currentHighlightedRect = null;
      let isBottomSheetOpen = false, isBottomSheetExpanded = false;
      const BOTTOM_SHEET_FULL_HEIGHT_VH = 90, BOTTOM_SHEET_PEEK_MAX_VH = 70;
      const BOTTOM_SHEET_PEEK_MIN_PX = 100, BOTTOM_SHEET_ANIMATION_DURATION = 300;
      let isSwipingBottomSheet = false, swipeStartY = 0, swipeStartTime = 0, initialSheetHeightOnSwipe = 0;
      const SWIPE_THRESHOLD_DISTANCE = 50, SWIPE_THRESHOLD_VELOCITY = 0.3;
      const AUTO_ZOOM_OUT_INITIAL_WAIT = 1800, INITIAL_ZOOM_TO_BUILDING_FACTOR = 0.5;
      const OVERVIEW_ZOOM_OUT_FACTOR = 4.0, ANIMATION_DURATION = 700;
      const HIGHLIGHT_DURATION_AFTER_ANIMATION = 2500;

      //--------------------------------------------------------------------
      // Utility Functions 
      //--------------------------------------------------------------------
      function cancelAllAutomatedSequences() { clearTimeout(autoZoomOutTimer); if (isAnimatingViewBox) { cancelAnimationFrame(animationFrameId); isAnimatingViewBox = false; } }
      function clearSearchHighlightAndTimers() { if (currentHighlightedRect) { currentHighlightedRect.classList.remove("search-highlight"); currentHighlightedRect = null; } clearTimeout(highlightTimeout); }
      function setMapViewBox(vb, calledFromAnimation = false) { if (!calledFromAnimation) { cancelAllAutomatedSequences(); if (!isAnimatingViewBox) clearSearchHighlightAndTimers(); } currentViewBox = { ...vb }; const panLimitFactor = 0.25; const minPanX = SVG_VIEWBOX_X - SVG_ORIGINAL_WIDTH * panLimitFactor; const maxPanX = SVG_VIEWBOX_X + SVG_ORIGINAL_WIDTH * (1 + panLimitFactor) - currentViewBox.width; const minPanY = SVG_VIEWBOX_Y - SVG_ORIGINAL_HEIGHT * panLimitFactor; const maxPanY = SVG_VIEWBOX_Y + SVG_ORIGINAL_HEIGHT * (1 + panLimitFactor) - currentViewBox.height; currentViewBox.x = Math.max(minPanX, Math.min(currentViewBox.x, maxPanX)); currentViewBox.y = Math.max(minPanY, Math.min(currentViewBox.y, maxPanY)); campusMap.setAttribute( "viewBox", `${currentViewBox.x} ${currentViewBox.y} ${currentViewBox.width} ${currentViewBox.height}` ); }
      function screenToSVGCoords(screenX, screenY) { const pt = campusMap.createSVGPoint(); pt.x = screenX; pt.y = screenY; const CTM = campusMap.getScreenCTM(); return CTM ? pt.matrixTransform(CTM.inverse()) : null; }
      function easeInOutQuad(t) { return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2; }
      function animateViewBox(targetVb, duration, onCompleteCallback = null) { if (isAnimatingViewBox) cancelAnimationFrame(animationFrameId); isAnimatingViewBox = true; const startVb = { ...currentViewBox }; const startTime = performance.now(); function animationStep(currentTime) { if (!isAnimatingViewBox) return; const elapsedTime = currentTime - startTime; let progress = Math.min(elapsedTime / duration, 1); const easedProgress = easeInOutQuad(progress); const interpolatedVb = { x: startVb.x + (targetVb.x - startVb.x) * easedProgress, y: startVb.y + (targetVb.y - startVb.y) * easedProgress, width: startVb.width + (targetVb.width - startVb.width) * easedProgress, height: startVb.height + (targetVb.height - startVb.height) * easedProgress, }; setMapViewBox(interpolatedVb, true); if (progress < 1) { animationFrameId = requestAnimationFrame(animationStep); } else { isAnimatingViewBox = false; setMapViewBox(targetVb, true); if (typeof onCompleteCallback === "function") onCompleteCallback(); } } animationFrameId = requestAnimationFrame(animationStep); }
      function zoomViewBox(zoomRatio, pivotSVG) { cancelAllAutomatedSequences(); clearSearchHighlightAndTimers(); let newWidth = currentViewBox.width * zoomRatio; newWidth = Math.max(MIN_ZOOM_WIDTH, Math.min(newWidth, MAX_ZOOM_WIDTH)); if ( (newWidth === currentViewBox.width && currentViewBox.width === MIN_ZOOM_WIDTH && zoomRatio > 1) || (newWidth === currentViewBox.width && currentViewBox.width === MAX_ZOOM_WIDTH && zoomRatio < 1) || (newWidth === currentViewBox.width) ) return; let newHeight = newWidth / SVG_ASPECT_RATIO; let newX, newY; if (pivotSVG) { newX = pivotSVG.x - (pivotSVG.x - currentViewBox.x) * (newWidth / currentViewBox.width); newY = pivotSVG.y - (pivotSVG.y - currentViewBox.y) * (newHeight / currentViewBox.height); } else { newX = currentViewBox.x + (currentViewBox.width - newWidth) / 2; newY = currentViewBox.y + (currentViewBox.height - newHeight) / 2; } setMapViewBox({ x: newX, y: newY, width: newWidth, height: newHeight }); }
      function normalizeString(str) { if (!str) return ""; return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/đ/g, "d"); }
      function debounce(func, delay) { return function (...args) { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => func.apply(this, args), delay); }; }
      function stopMousePan() { if (isPointerDown && !isPinching) { isPointerDown = false; campusMap.classList.remove("grabbing"); } }
      function getTouchDistance(t1, t2) { return Math.sqrt( Math.pow(t1.clientX - t2.clientX, 2) + Math.pow(t1.clientY - t2.clientY, 2) ); }
      function getTouchMidpoint(t1, t2) { return { x: (t1.clientX + t2.clientX) / 2, y: (t1.clientY + t2.clientY) / 2 }; }

      //--------------------------------------------------------------------
      // Bottom Sheet Logic
      //--------------------------------------------------------------------
      function calculatePeekHeight() { const mapContainerEl = campusMap.closest(".map-container"); const imageContainer = document.querySelector('.inserted-image-container'); if (!mapContainerEl) { return BOTTOM_SHEET_PEEK_MIN_PX; } const mapContainerRect = mapContainerEl.getBoundingClientRect(); const viewportHeight = window.innerHeight; const bottomElement = imageContainer || mapContainerEl; const spaceBelow = viewportHeight - bottomElement.getBoundingClientRect().bottom - 10; let sheetHeight = Math.max( BOTTOM_SHEET_PEEK_MIN_PX, Math.min(spaceBelow, viewportHeight * (BOTTOM_SHEET_PEEK_MAX_VH / 100)) ); return Math.max(0, sheetHeight); }
      function setSheetToPeekHeight() { const peekHeight = calculatePeekHeight(); bottomSheet.style.height = peekHeight + "px"; isBottomSheetExpanded = false; if (toggleBottomSheetHeightBtn) { toggleBottomSheetHeightBtn.classList.remove("expanded"); toggleBottomSheetHeightBtn.setAttribute("aria-label", "Mở rộng"); toggleBottomSheetHeightBtn.querySelector(".icon-arrow-up").style.display = "block"; toggleBottomSheetHeightBtn.querySelector(".icon-arrow-down").style.display = "none"; } }
      function setSheetToFullHeight() { const fullHeight = window.innerHeight * (BOTTOM_SHEET_FULL_HEIGHT_VH / 100); bottomSheet.style.height = fullHeight + "px"; isBottomSheetExpanded = true; if (toggleBottomSheetHeightBtn) { toggleBottomSheetHeightBtn.classList.add("expanded"); toggleBottomSheetHeightBtn.setAttribute("aria-label", "Thu gọn"); toggleBottomSheetHeightBtn.querySelector(".icon-arrow-up").style.display = "none"; toggleBottomSheetHeightBtn.querySelector(".icon-arrow-down").style.display = "block"; } }

      function setupTabNavigation(contentRootElement, entityToHighlight = null, entityFoundInUnits = false) {
          const tabNavigation = contentRootElement.querySelector('[data-role="tab-navigation"]');
          if (!tabNavigation) return;

          const tabButtons = tabNavigation.querySelectorAll('.tab-button');
          const tabPanels = contentRootElement.querySelectorAll('.tab-content-area .tab-panel');

          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabPanels.forEach(panel => {
              panel.classList.remove('active');
              panel.style.display = 'none';
          });

          let defaultActiveButton = null;
          let targetPanelIdForHighlight = null;

          if (entityToHighlight && entityFoundInUnits) {
              defaultActiveButton = tabNavigation.querySelector('.tab-button[data-tab-target="#tab-units"]');
              if (defaultActiveButton && defaultActiveButton.style.display !== 'none') {
                targetPanelIdForHighlight = '#tab-units';
              } else { // Nút tab bị ẩn, reset
                defaultActiveButton = null; 
              }
          }
          // Thêm logic tương tự nếu có entity được tìm thấy trong các tab khác (ví dụ: tab CLB)
          // else if (entityToHighlight && entityFoundInClubs) { ... defaultActiveButton = ...("[data-tab-target='#tab-clubs']"); targetPanelIdForHighlight = '#tab-clubs'; ...}
          
          if (!defaultActiveButton) {
              defaultActiveButton = tabNavigation.querySelector('.tab-button[data-tab-target="#tab-overview"]');
              if (!defaultActiveButton || defaultActiveButton.style.display === 'none') {
                  for (const btn of tabButtons) { // Tìm tab đầu tiên hiển thị
                      if (btn.style.display !== 'none') {
                          defaultActiveButton = btn;
                          break;
                      }
                  }
              }
          }
          
          if (defaultActiveButton) {
              defaultActiveButton.classList.add('active');
              const activePanelId = defaultActiveButton.dataset.tabTarget; // Lấy ID panel từ nút active
              const activePanel = contentRootElement.querySelector(activePanelId);
              if (activePanel) {
                  activePanel.classList.add('active');
                  activePanel.style.display = 'block';

                  if (entityToHighlight && activePanelId === targetPanelIdForHighlight) {
                      setTimeout(() => { 
                          const highlightedEl = activePanel.querySelector('.highlighted-entity');
                          if (highlightedEl) {
                              highlightedEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                          }
                      }, 100); 
                  }
              }
          }

          tabButtons.forEach(button => {
              button.addEventListener('click', () => {
                  if (button.classList.contains('active') || button.style.display === 'none') return;
                  const targetPanelId = button.dataset.tabTarget;
                  const targetPanel = contentRootElement.querySelector(targetPanelId);
                  tabButtons.forEach(btn => btn.classList.remove('active'));
                  button.classList.add('active');
                  tabPanels.forEach(panel => { panel.classList.remove('active'); panel.style.display = 'none'; });
                  if (targetPanel) { targetPanel.classList.add('active'); targetPanel.style.display = 'block'; }
              });
          });
      }

      function populateBottomSheetContent(detailedData, entityToHighlight = null) { 
          if (!buildingDetailTemplate) { console.error("populateBottomSheetContent: Template không tồn tại."); bottomSheetContent.innerHTML = '<p class="error-message">Lỗi: Không thể hiển thị chi tiết (template missing).</p>'; return; }
          const buildingNameText = detailedData.name || "Thông tin chi tiết"; 
          const buildingDetailText = detailedData.detail || "Chưa có thông tin cho tòa nhà này.";
          bottomSheetTitle.textContent = buildingNameText; 
          bottomSheetContent.innerHTML = ''; 
          const templateClone = buildingDetailTemplate.content.cloneNode(true);

          const mainImageContainer = templateClone.querySelector('[data-role="image-container"]');
          const mainImgElement = templateClone.querySelector('[data-role="building-image"]');
          const mainNameElement = templateClone.querySelector('[data-role="building-name"]');
          if (detailedData.imageUrl && mainImgElement && mainImageContainer) { mainImgElement.src = detailedData.imageUrl; mainImgElement.alt = `Ảnh ${buildingNameText}`; } 
          else if (mainImageContainer) { mainImageContainer.remove(); }
          if (mainNameElement) mainNameElement.textContent = buildingNameText;

          const descriptionElement = templateClone.querySelector('[data-role="building-description"]');
          if (descriptionElement) descriptionElement.innerHTML = buildingDetailText; 

          const detailImagesSection = templateClone.querySelector('[data-role="detail-images-section"]');
          if (detailImagesSection) {
              if (detailedData.detailImages && Array.isArray(detailedData.detailImages) && detailedData.detailImages.length > 0) {
                  detailedData.detailImages.forEach(imageData => { const img = document.createElement('img'); img.src = imageData.src; img.alt = imageData.alt || buildingNameText; img.style.height = '80px'; img.onerror = function() { this.style.display = 'none'; console.warn('Lỗi tải ảnh chi tiết: ' + this.src); }; detailImagesSection.appendChild(img); });
                  detailImagesSection.style.display = ''; 
              } else { detailImagesSection.style.display = 'none'; }
          }
          // ... (Tương tự cho phone, website, services trong tab Tổng quan) ...
          const openingHoursSection = templateClone.querySelector('[data-role="opening-hours-section"]');
          const openingHoursList = templateClone.querySelector('[data-role="building-opening-hours-list"]');
          if (openingHoursSection && openingHoursList) { if (detailedData.openingHours && Array.isArray(detailedData.openingHours) && detailedData.openingHours.length > 0) { detailedData.openingHours.forEach(item => { const li = document.createElement('li'); li.textContent = item; openingHoursList.appendChild(li); }); openingHoursSection.style.display = ''; } else { openingHoursSection.style.display = 'none'; } }
          const phoneSection = templateClone.querySelector('[data-role="phone-section"]');
          const phoneElement = templateClone.querySelector('[data-role="building-phone"]');
          if (phoneSection && phoneElement) { if (detailedData.phone) { phoneElement.textContent = detailedData.phone; phoneSection.style.display = '';}  else { phoneSection.style.display = 'none'; } }
          const websiteSection = templateClone.querySelector('[data-role="website-section"]');
          const websiteLink = templateClone.querySelector('[data-role="building-website-link"]');
          const websiteText = templateClone.querySelector('[data-role="building-website-text"]');
          if (websiteSection && websiteLink && websiteText) { if (detailedData.website) { let fullUrl = detailedData.website; if (!fullUrl.startsWith('http://') && !fullUrl.startsWith('https://')) { fullUrl = 'https://' + fullUrl; } websiteLink.href = fullUrl; websiteText.textContent = detailedData.website; websiteSection.style.display = ''; } else { websiteSection.style.display = 'none'; } }
          const servicesSection = templateClone.querySelector('[data-role="services-section"]');
          const servicesList = templateClone.querySelector('[data-role="building-services-list"]');
          if (servicesSection && servicesList) { if (detailedData.services && Array.isArray(detailedData.services) && detailedData.services.length > 0) { detailedData.services.forEach(item => { const li = document.createElement('li'); li.textContent = item; servicesList.appendChild(li); }); servicesSection.style.display = ''; } else { servicesSection.style.display = 'none'; } }
          
          // --- Điền thông tin cho Tab "Đơn vị" ---
          const unitsListElement = templateClone.querySelector('[data-role="units-list"]');
          const unitsTabButton = templateClone.querySelector('[data-role="units-tab-button"]');
          const unitsContentPanel = templateClone.querySelector('#tab-units');
          let entityFoundInUnitsTab = false;

          if (unitsListElement && unitsTabButton && unitsContentPanel) {
              if (detailedData.units && Array.isArray(detailedData.units) && detailedData.units.length > 0) {
                  detailedData.units.forEach(unit => {
                      const li = document.createElement('li');
                      let unitHTML = `<strong>${unit.unitName || 'N/A'}</strong>`;
                      if (unit.type) unitHTML += `<br><small>Loại: ${unit.type}</small>`;
                      if (unit.officeLocation) unitHTML += `<br><small>Văn phòng: ${unit.officeLocation}</small>`;
                      if (unit.phone) unitHTML += `<br><small>ĐT: ${unit.phone}</small>`;
                      if (unit.email) unitHTML += `<br><small>Email: ${unit.email}</small>`;
                      if (unit.website) unitHTML += `<br><small>Website: <a href="${(unit.website.startsWith('http') ? '' : 'https://') + unit.website}" target="_blank" rel="noopener noreferrer">${unit.website}</a></small>`;
                      if (unit.description) unitHTML += `<br><small>Mô tả: ${unit.description}</small>`;
                      li.innerHTML = unitHTML;
                      if (entityToHighlight && unit.unitName && normalizeString(unit.unitName) === normalizeString(entityToHighlight)) {
                          li.classList.add('highlighted-entity');
                          entityFoundInUnitsTab = true;
                      }
                      unitsListElement.appendChild(li);
                  });
                  unitsTabButton.style.display = ''; 
              } else {
                  unitsTabButton.style.display = 'none'; 
                  if(unitsContentPanel) unitsContentPanel.remove(); 
              }
          }
          
          bottomSheetContent.appendChild(templateClone); 
          setupTabNavigation(bottomSheetContent, entityToHighlight, entityFoundInUnitsTab ? '#tab-units' : null); 
          bottomSheetContent.scrollTop = 0;
      }

      function openBottomSheetOnly(initialName = "Thông tin chi tiết") { /* Giữ nguyên */ if(isBottomSheetOpen && bottomSheetTitle.textContent !== "Đang tải...") { if (bottomSheetTitle.textContent !== initialName) { bottomSheetTitle.textContent = initialName; } if (!isBottomSheetExpanded) setSheetToPeekHeight(); return;  } bottomSheetTitle.textContent = initialName; setSheetToPeekHeight(); bottomSheet.classList.add("open"); bottomSheetBackdrop.classList.add("open"); document.body.style.overflow = "hidden"; isBottomSheetOpen = true; }
      function closeBottomSheet() { /* Giữ nguyên */ if (!isBottomSheetOpen) return; bottomSheet.classList.remove("open"); bottomSheetBackdrop.classList.remove("open"); document.body.style.overflow = ""; bottomSheet.style.height = ""; isBottomSheetExpanded = false; if (toggleBottomSheetHeightBtn) { toggleBottomSheetHeightBtn.classList.remove("expanded"); toggleBottomSheetHeightBtn.setAttribute("aria-label", "Mở rộng"); toggleBottomSheetHeightBtn.querySelector(".icon-arrow-up").style.display = "block"; toggleBottomSheetHeightBtn.querySelector(".icon-arrow-down").style.display = "none"; } const wasOpen = isBottomSheetOpen; isBottomSheetOpen = false; setTimeout(() => { if (!isBottomSheetOpen && wasOpen) { bottomSheetTitle.textContent = "Thông tin tòa nhà"; bottomSheetContent.innerHTML = `<p class="placeholder">Chọn một tòa nhà trên bản đồ hoặc từ kết quả tìm kiếm để xem thông tin chi tiết.</p>`; } }, BOTTOM_SHEET_ANIMATION_DURATION); clearSearchHighlightAndTimers(); }
      function toggleBottomSheetExpansion() { /* Giữ nguyên */ if (!isBottomSheetOpen || isSwipingBottomSheet) return; if (isBottomSheetExpanded) { setSheetToPeekHeight(); } else { setSheetToFullHeight(); } }
      function handleTouchStart(event) { /* Giữ nguyên */ if (!event.target.closest('#bottomSheetHeader') || isAnimatingViewBox) return; isSwipingBottomSheet = true; swipeStartY = event.touches[0].clientY; swipeStartTime = Date.now(); initialSheetHeightOnSwipe = bottomSheet.offsetHeight; bottomSheet.classList.add('no-transition'); }
      function handleTouchMove(event) { /* Giữ nguyên */ if (!isSwipingBottomSheet) return; event.preventDefault(); const currentY = event.touches[0].clientY; let deltaY = currentY - swipeStartY; let newHeight = initialSheetHeightOnSwipe - deltaY; const minDragHeight = 50; const maxDragHeight = window.innerHeight - 20; newHeight = Math.max(minDragHeight, Math.min(newHeight, maxDragHeight)); bottomSheet.style.height = newHeight + 'px'; }
      function handleTouchEnd(event) { /* Giữ nguyên */ if (!isSwipingBottomSheet) return; isSwipingBottomSheet = false; bottomSheet.classList.remove('no-transition'); const currentY = event.changedTouches[0].clientY; const deltaY = currentY - swipeStartY; const swipeDuration = Date.now() - swipeStartTime; const velocity = swipeDuration > 0 ? deltaY / swipeDuration : 0; const currentHeight = bottomSheet.offsetHeight; const peekHeight = calculatePeekHeight(); const fullHeight = window.innerHeight * (BOTTOM_SHEET_FULL_HEIGHT_VH / 100); if ((deltaY > SWIPE_THRESHOLD_DISTANCE || velocity > SWIPE_THRESHOLD_VELOCITY) && initialSheetHeightOnSwipe <= peekHeight + 20) { closeBottomSheet(); return; } if ((deltaY > SWIPE_THRESHOLD_DISTANCE || velocity > SWIPE_THRESHOLD_VELOCITY) && isBottomSheetExpanded) { setSheetToPeekHeight(); return; } if ((deltaY < -SWIPE_THRESHOLD_DISTANCE || velocity < -SWIPE_THRESHOLD_VELOCITY) && !isBottomSheetExpanded) { setSheetToFullHeight(); return; } if (isBottomSheetExpanded) { if (currentHeight < fullHeight - SWIPE_THRESHOLD_DISTANCE) { setSheetToPeekHeight(); } else { setSheetToFullHeight(); } } else { if (currentHeight > peekHeight + SWIPE_THRESHOLD_DISTANCE) { setSheetToFullHeight(); } else { setSheetToPeekHeight(); } } }

      //--------------------------------------------------------------------
      // Search Logic
      //--------------------------------------------------------------------
      function performSearch() {
          cancelAllAutomatedSequences(); clearSearchHighlightAndTimers();
          const query = searchInput.value; const normalizedQuery = normalizeString(query);
          searchResultsList.innerHTML = "";
          if (!query.trim()) { searchResultsContainer.style.display = "none"; return; }
          const matches = [];
          for (const buildingSummary of buildingData) { 
              let matchedEntity = null; 
              let buildingMatchBasis = null; 
              if (buildingSummary && buildingSummary.name && buildingSummary.id) {
                  const normalizedName = normalizeString(buildingSummary.name);
                  const normalizedId = normalizeString(buildingSummary.id);
                  if (normalizedName.includes(normalizedQuery) || normalizedId.includes(normalizedQuery)) { buildingMatchBasis = buildingSummary.name; }
                  if (buildingSummary.tags && Array.isArray(buildingSummary.tags)) {
                      for (const tag of buildingSummary.tags) {
                          if (normalizeString(tag).includes(normalizedQuery)) { matchedEntity = tag; break; }
                      }
                  }
                  if (matchedEntity) { matches.push({ id: buildingSummary.id, name: buildingSummary.name, matchedEntityName: matchedEntity }); } 
                  else if (buildingMatchBasis) { matches.push({ id: buildingSummary.id, name: buildingSummary.name, matchedEntityName: null }); }
              }
          }
          const uniqueMatchesMap = new Map();
          matches.forEach(match => { const key = match.id; if (!uniqueMatchesMap.has(key) || (match.matchedEntityName && !uniqueMatchesMap.get(key).matchedEntityName)) { uniqueMatchesMap.set(key, match); } });
          const uniqueMatches = Array.from(uniqueMatchesMap.values());
          uniqueMatches.sort((a, b) => (a.matchedEntityName || a.name).localeCompare(b.matchedEntityName || b.name, "vi"));
          searchResultsList.innerHTML = ""; 
          if (uniqueMatches.length > 0) {
              uniqueMatches.slice(0, 7).forEach((match) => { 
                  const li = document.createElement("li");
                  if (match.matchedEntityName) { li.innerHTML = `<strong>${match.matchedEntityName}</strong> <small>(tại ${match.name})</small>`; } 
                  else { li.textContent = match.name + ` (${match.id.toUpperCase()})`; }
                  li.dataset.buildingId = match.id; 
                  li.dataset.entityName = match.matchedEntityName || ''; 
                  li.addEventListener("click", () => handleSearchResultClick(match.id, match.matchedEntityName)); 
                  searchResultsList.appendChild(li);
              });
              searchResultsContainer.style.display = "block";
          } else { searchResultsList.innerHTML = '<li class="no-results">Không có kết quả phù hợp.</li>'; searchResultsContainer.style.display = "block"; }
      }

      async function fetchAndDisplayBuildingDetails(buildingId, entityNameToHighlight = null) {
          const buildingSummary = buildingData.find(b => b.id === buildingId);
          const initialName = buildingSummary ? buildingSummary.name : "Đang tải...";
          openBottomSheetOnly(initialName); 
          bottomSheetContent.innerHTML = '<p class="placeholder">Đang tải thông tin chi tiết...</p>';
          if (detailedBuildingDataCache[buildingId]) {
              populateBottomSheetContent(detailedBuildingDataCache[buildingId], entityNameToHighlight);
              return detailedBuildingDataCache[buildingId]; 
          }
          try {
              const response = await fetch(`data/buildings/${buildingId}.json?t=${new Date().getTime()}`); 
              if (!response.ok) { throw new Error(`Không tìm thấy file chi tiết cho ${buildingId} (status: ${response.status})`); }
              const detailedData = await response.json();
              detailedBuildingDataCache[buildingId] = detailedData; 
              populateBottomSheetContent(detailedData, entityNameToHighlight);
              return detailedData; 
          } catch (error) {
              console.error("Lỗi tải dữ liệu chi tiết cho " + buildingId + ":", error);
              bottomSheetTitle.textContent = "Lỗi";
              bottomSheetContent.innerHTML = `<p class="error-message">Không thể tải thông tin chi tiết. <br><small>${error.message}</small></p>`;
              throw error; 
          }
      }

      function handleSearchResultClick(buildingId, entityNameToHighlight = null) { cancelAllAutomatedSequences(); clearSearchHighlightAndTimers(); const buildingRectEl = document.getElementById(buildingId); if (!buildingRectEl) { console.error(`SVG element for ID: ${buildingId} not found.`); return; } fetchAndDisplayBuildingDetails(buildingId, entityNameToHighlight) .then(detailedData => { if (!detailedData) return; const rectCoords = buildingRectEl.getBBox(); let targetInitialWidth, targetInitialHeight; if (rectCoords.width / rectCoords.height > SVG_ASPECT_RATIO) { targetInitialWidth = rectCoords.width / INITIAL_ZOOM_TO_BUILDING_FACTOR; targetInitialHeight = targetInitialWidth / SVG_ASPECT_RATIO; }  else { targetInitialHeight = rectCoords.height / INITIAL_ZOOM_TO_BUILDING_FACTOR; targetInitialWidth = targetInitialHeight * SVG_ASPECT_RATIO; } targetInitialWidth = Math.max( MIN_ZOOM_WIDTH * 1.5, Math.min(targetInitialWidth, SVG_ORIGINAL_WIDTH * 0.9) ); targetInitialHeight = targetInitialWidth / SVG_ASPECT_RATIO; const initialZoomX = rectCoords.x + rectCoords.width / 2 - targetInitialWidth / 2; const initialZoomY = rectCoords.y + rectCoords.height / 2 - targetInitialHeight / 2; const initialZoomViewBox = { x: initialZoomX, y: initialZoomY, width: targetInitialWidth, height: targetInitialHeight }; buildingRectEl.classList.add("search-highlight"); currentHighlightedRect = buildingRectEl; searchInput.value = ""; searchResultsContainer.style.display = "none"; animateViewBox(initialZoomViewBox, ANIMATION_DURATION, () => { autoZoomOutTimer = setTimeout(() => { if (!currentHighlightedRect || currentHighlightedRect.id !== buildingId) return; const focusedVB = { ...currentViewBox }; let overviewWidth = Math.min( SVG_ORIGINAL_WIDTH, focusedVB.width * OVERVIEW_ZOOM_OUT_FACTOR ); let overviewHeight = overviewWidth / SVG_ASPECT_RATIO; if (overviewHeight > SVG_ORIGINAL_HEIGHT) { overviewHeight = SVG_ORIGINAL_HEIGHT; overviewWidth = overviewHeight * SVG_ASPECT_RATIO; } if ( Math.abs(overviewWidth - focusedVB.width) < 10 && Math.abs(overviewHeight - focusedVB.height) < 10 ) { if ( (focusedVB.width < SVG_ORIGINAL_WIDTH || focusedVB.height < SVG_ORIGINAL_HEIGHT) && currentHighlightedRect ) { animateViewBox( { x: SVG_VIEWBOX_X, y: SVG_VIEWBOX_Y, width: SVG_ORIGINAL_WIDTH, height: SVG_ORIGINAL_HEIGHT }, ANIMATION_DURATION, () => { if (currentHighlightedRect) { highlightTimeout = setTimeout( clearSearchHighlightAndTimers, HIGHLIGHT_DURATION_AFTER_ANIMATION ); } }, ); } else if (currentHighlightedRect) { highlightTimeout = setTimeout( clearSearchHighlightAndTimers, HIGHLIGHT_DURATION_AFTER_ANIMATION ); } return; } const overviewX = focusedVB.x + (focusedVB.width - overviewWidth) / 2; const overviewY = focusedVB.y + (focusedVB.height - overviewHeight) / 2; const targetOverviewVb = { x: overviewX, y: overviewY, width: overviewWidth, height: overviewHeight }; animateViewBox(targetOverviewVb, ANIMATION_DURATION, () => { if (currentHighlightedRect) { highlightTimeout = setTimeout( clearSearchHighlightAndTimers, HIGHLIGHT_DURATION_AFTER_ANIMATION ); } }); }, AUTO_ZOOM_OUT_INITIAL_WAIT); }); }) .catch(error => { console.error("Search click: Failed to display building details:", error); }); }

      //--------------------------------------------------------------------
      // Initialization Function & Event Listeners Setup
      //--------------------------------------------------------------------
      function setupEventListeners() { 
        searchInput.addEventListener("input", debounce(performSearch, 300)); 
        document.addEventListener("click", function (event) { if ( searchResultsContainer.style.display === "block" && !searchInput.contains(event.target) && !searchResultsContainer.contains(event.target) ) { searchResultsContainer.style.display = "none"; } }); 
        searchInput.addEventListener("keydown", function (event) { if (event.key === "Escape") { searchInput.value = ""; searchResultsContainer.style.display = "none"; searchInput.blur(); cancelAllAutomatedSequences(); clearSearchHighlightAndTimers(); } }); 
        campusMap.addEventListener("mousedown", (event) => { if (event.target.closest('#bottomSheetHeader')) return; cancelAllAutomatedSequences(); clearSearchHighlightAndTimers(); if (event.button !== 0) return; isPointerDown = true; pointerStartCoords = { x: event.clientX, y: event.clientY }; viewBoxOnPointerDown = { ...currentViewBox }; campusMap.classList.add("grabbing"); tapStart = { x: event.clientX, y: event.clientY, time: Date.now() }; }); 
        campusMap.addEventListener("mousemove", (event) => { if (event.target.closest('#bottomSheetHeader')) return; if (!isPointerDown || isPinching || isAnimatingViewBox) return; const dxScreen = event.clientX - pointerStartCoords.x; const dyScreen = event.clientY - pointerStartCoords.y; const clientRect = campusMap.getBoundingClientRect(); if (clientRect.width === 0 || clientRect.height === 0) return; const scaleX = currentViewBox.width / clientRect.width; const scaleY = currentViewBox.height / clientRect.height; const newX = viewBoxOnPointerDown.x - dxScreen * scaleX; const newY = viewBoxOnPointerDown.y - dyScreen * scaleY; setMapViewBox({ x: newX, y: newY, width: currentViewBox.width, height: currentViewBox.height }); }); 
        campusMap.addEventListener("mouseup", stopMousePan); 
        campusMap.addEventListener("mouseleave", stopMousePan); 
        window.addEventListener("blur", stopMousePan); 
        campusMap.addEventListener("wheel", (event) => { if (event.target.closest('#bottomSheetHeader')) return; event.preventDefault(); cancelAllAutomatedSequences(); clearSearchHighlightAndTimers(); const pivot = screenToSVGCoords(event.clientX, event.clientY); if (!pivot) return; const zoomRatio = event.deltaY < 0 ? 1 / ZOOM_FACTOR : ZOOM_FACTOR; zoomViewBox(zoomRatio, pivot); }); 
        campusMap.addEventListener( "touchstart", (event) => { if (event.target.closest('#bottomSheetHeader')) return; cancelAllAutomatedSequences(); clearSearchHighlightAndTimers(); if (!event.target.closest('input, button, a')) { event.preventDefault(); } isPointerDown = true; campusMap.classList.add("grabbing"); if (event.touches.length === 1) { const touch = event.touches[0]; pointerStartCoords = { x: touch.clientX, y: touch.clientY }; viewBoxOnPointerDown = { ...currentViewBox }; tapStart = { x: touch.clientX, y: touch.clientY, time: Date.now() }; isPinching = false; } else if (event.touches.length === 2) { isPinching = true; initialPinchDistance = getTouchDistance( event.touches[0], event.touches[1] ); viewBoxOnPointerDown = { ...currentViewBox }; } }, { passive: false } ); 
        campusMap.addEventListener( "touchmove", (event) => { if (event.target.closest('#bottomSheetHeader')) return; if (!isPointerDown || isAnimatingViewBox) return; if (!event.target.closest('input, button, a')) { event.preventDefault(); } if (isPinching && event.touches.length === 2) { const currentPinchDistance = getTouchDistance( event.touches[0], event.touches[1] ); if (initialPinchDistance === 0) { initialPinchDistance = currentPinchDistance; viewBoxOnPointerDown = { ...currentViewBox }; return; } const zoomRatio = currentPinchDistance / initialPinchDistance; const screenMidpoint = getTouchMidpoint( event.touches[0], event.touches[1] ); const svgMidpoint = screenToSVGCoords(screenMidpoint.x, screenMidpoint.y); if (svgMidpoint) { let newWidth = viewBoxOnPointerDown.width / zoomRatio; newWidth = Math.max(MIN_ZOOM_WIDTH, Math.min(newWidth, MAX_ZOOM_WIDTH)); let newHeight = newWidth / SVG_ASPECT_RATIO; let newViewBoxX = svgMidpoint.x - (svgMidpoint.x - viewBoxOnPointerDown.x) * (newWidth / viewBoxOnPointerDown.width); let newViewBoxY = svgMidpoint.y - (svgMidpoint.y - viewBoxOnPointerDown.y) * (newHeight / viewBoxOnPointerDown.height); setMapViewBox({ x: newViewBoxX, y: newViewBoxY, width: newWidth, height: newHeight }); } } else if (!isPinching && event.touches.length === 1) { const touch = event.touches[0]; const dxScreen = touch.clientX - pointerStartCoords.x; const dyScreen = touch.clientY - pointerStartCoords.y; const clientRect = campusMap.getBoundingClientRect(); if (clientRect.width === 0 || clientRect.height === 0) return; const scaleX = currentViewBox.width / clientRect.width; const scaleY = currentViewBox.height / clientRect.height; const newX = viewBoxOnPointerDown.x - dxScreen * scaleX; const newY = viewBoxOnPointerDown.y - dyScreen * scaleY; setMapViewBox({ x: newX, y: newY, width: currentViewBox.width, height: currentViewBox.height }); } }, { passive: false } ); 
        campusMap.addEventListener("touchend", (event) => { 
            if (event.target.closest('#bottomSheetHeader')) return; 
            if ( !isPinching && event.changedTouches.length === 1 && isPointerDown && !isAnimatingViewBox ) { 
                const touch = event.changedTouches[0]; const timeElapsed = Date.now() - tapStart.time; 
                const distMoved = Math.sqrt( Math.pow(touch.clientX - tapStart.x, 2) + Math.pow(touch.clientY - tapStart.y, 2) ); 
                if (timeElapsed < TAP_THRESHOLD_MS && distMoved < TAP_MOVE_THRESHOLD_PX) { 
                    let targetElement = document.elementFromPoint(tapStart.x, tapStart.y); 
                    if (targetElement && targetElement.closest) { 
                        targetElement = targetElement.closest(".building-rect"); 
                        if (targetElement) { 
                            const buildingId = targetElement.id; 
                            cancelAllAutomatedSequences(); clearSearchHighlightAndTimers(); 
                            const currentTargetEl = targetElement; 
                            fetchAndDisplayBuildingDetails(buildingId) // Không truyền entityNameToHighlight khi click map
                                .then(detailedData => { if (detailedData) { currentTargetEl.classList.add("search-highlight"); currentHighlightedRect = currentTargetEl; } searchResultsContainer.style.display = "none"; searchInput.value = ""; })
                                .catch(error => { console.error("Map tap: Failed to display details:", error); });
                        } 
                    } 
                } 
            } 
            if (event.touches.length < 2) isPinching = false; 
            if (event.touches.length === 0) { if (isPointerDown) { isPointerDown = false; campusMap.classList.remove("grabbing"); } } 
        }); 
        campusMap.addEventListener("touchcancel", (event) => { if (event.target.closest('#bottomSheetHeader')) return; isPointerDown = false; isPinching = false; campusMap.classList.remove("grabbing"); cancelAllAutomatedSequences(); clearSearchHighlightAndTimers(); }); 
        document.querySelectorAll(".building-rect").forEach((el) => { 
            el.addEventListener("click", (event) => { 
                const timeSinceTapStart = Date.now() - (tapStart.time || 0); 
                const clientX = event.clientX; const clientY = event.clientY; 
                const distMoved = Math.sqrt( Math.pow(clientX - (tapStart.x || clientX), 2) + Math.pow(clientY - (tapStart.y || clientY), 2) ); 
                if ( isPinching || isAnimatingViewBox || isSwipingBottomSheet || (isPointerDown && (timeSinceTapStart > TAP_THRESHOLD_MS || distMoved > TAP_MOVE_THRESHOLD_PX)) ) return; 
                const buildingRectEl = event.target.closest(".building-rect"); 
                if (!buildingRectEl) return; 
                const buildingId = buildingRectEl.id; 
                cancelAllAutomatedSequences(); clearSearchHighlightAndTimers(); 
                fetchAndDisplayBuildingDetails(buildingId) // Không truyền entityNameToHighlight khi click map
                    .then(detailedData => { if (detailedData) { buildingRectEl.classList.add("search-highlight"); currentHighlightedRect = buildingRectEl; } searchResultsContainer.style.display = "none"; searchInput.value = ""; })
                    .catch(error => { console.warn(`Map click: Failed to display details for ${buildingId}:`, error); });
            }); 
        }); 
        closeBottomSheetBtn.addEventListener("click", closeBottomSheet); 
        bottomSheetBackdrop.addEventListener("click", closeBottomSheet); 
        if (toggleBottomSheetHeightBtn) { toggleBottomSheetHeightBtn.addEventListener("click", toggleBottomSheetExpansion); } 
        bottomSheetHeader.addEventListener('touchstart', handleTouchStart, { passive: true }); 
        document.addEventListener('touchmove', handleTouchMove, { passive: false }); 
        document.addEventListener('touchend', handleTouchEnd, { passive: true }); 
        document.addEventListener('touchcancel', handleTouchEnd, { passive: true }); 
        resetZoomBtn.addEventListener("click", () => { cancelAllAutomatedSequences(); clearSearchHighlightAndTimers(); closeBottomSheet(); setMapViewBox({ x: SVG_VIEWBOX_X, y: SVG_VIEWBOX_Y, width: SVG_ORIGINAL_WIDTH, height: SVG_ORIGINAL_HEIGHT }); }); 
        window.addEventListener("resize", () => { if (isBottomSheetOpen) { if (isBottomSheetExpanded) { setSheetToFullHeight(); } else { setSheetToPeekHeight(); } } }); 
    }

      function initializeMapApp() {
          buildingDetailTemplate = document.getElementById('buildingDetailTemplate');
          if (!buildingDetailTemplate) {
              console.error("LỖI QUAN TRỌNG: Không tìm thấy #buildingDetailTemplate.");
              if(bottomSheetContent) bottomSheetContent.innerHTML = '<p class="error-message">Lỗi cấu hình: Không thể tải template chi tiết.</p>';
          }
          try {
              const placeholder = bottomSheetContent.querySelector('.placeholder');
              if (placeholder && placeholder.textContent && placeholder.textContent.includes('Đang tải dữ liệu bản đồ...')) {
                   placeholder.textContent = 'Chọn một tòa nhà trên bản đồ hoặc từ kết quả tìm kiếm để xem thông tin chi tiết.';
              } else if ((!placeholder && bottomSheetContent.innerHTML.trim() === '') || (placeholder && placeholder.textContent.includes('Lỗi tải dữ liệu bản đồ chính'))) {
                  bottomSheetContent.innerHTML = '<p class="placeholder">Chọn một tòa nhà trên bản đồ hoặc từ kết quả tìm kiếm để xem thông tin chi tiết.</p>';
              }
              setupEventListeners();
              setMapViewBox(currentViewBox); 
          } catch (initError) {
               console.error("Lỗi BÊN TRONG initializeMapApp:", initError);
               if(bottomSheetContent) bottomSheetContent.innerHTML = `<p class="placeholder error-message">Lỗi khởi tạo ứng dụng. Chi tiết: ${initError.message}. Vui lòng thử tải lại trang.</p>`;
          }
      }

      //--------------------------------------------------------------------
      // Data Loading Function 
      //--------------------------------------------------------------------
      async function loadBuildingData() {
          try {
              const response = await fetch('buildings_index.json?t=' + new Date().getTime()); 
              if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}, statusText: ${response.statusText} (Khi tải buildings_index.json)`); }
              const contentType = response.headers.get("content-type");
              if (!contentType || !contentType.includes("application/json")) { console.warn(`Warn: Response content-type của buildings_index.json không phải là JSON (${contentType}). Vẫn thử parse.`); }
              buildingData = await response.json(); 
              if (!Array.isArray(buildingData)) { throw new Error("Dữ liệu từ buildings_index.json không phải là một mảng."); }
              initializeMapApp(); 
              searchInput.disabled = false; 
              searchInput.placeholder = "Tìm tên hoặc mã tòa nhà, khoa, viện..."; // Cập nhật placeholder
          } catch (error) {
              console.error("Không thể tải hoặc phân tích dữ liệu index tòa nhà:", error);
              if(bottomSheetContent) bottomSheetContent.innerHTML = `<p class="placeholder error-message">Lỗi tải dữ liệu bản đồ chính. Chi tiết: ${error.message}. Vui lòng kiểm tra file 'buildings_index.json' và cấu trúc thư mục 'data/buildings/' hoặc thử lại sau.</p>`;
              if(searchInput) { searchInput.placeholder = "Lỗi tải dữ liệu..."; searchInput.disabled = true; }
          }
      }
      //--------------------------------------------------------------------
      // Start Application
      //--------------------------------------------------------------------
      loadBuildingData();
    </script>
  </body>
</html>

